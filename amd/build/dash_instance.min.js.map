{"version":3,"file":"dash_instance.min.js","sources":["../src/dash_instance.js"],"sourcesContent":["define(['jquery', 'jqueryui', 'core/log', 'core/ajax', 'core/notification', 'core/modal_events',\r\n    'block_dash/preferences_modal', 'block_dash/datepicker', 'block_dash/select2', 'core/fragment', 'core/templates'],\r\n    function($, UI, Log, Ajax, Notification, ModalEvents, PreferencesModal, DatePicker, Select2, Fragment, Templates) {\r\n\r\n        var DashInstance = function(root, blockInstanceId, blockContextid, editing, istotara, pagelayout) {\r\n            this.root = $(root);\r\n            this.blockInstanceId = blockInstanceId;\r\n            this.blockContextid = blockContextid;\r\n            this.currentPage = 0;\r\n            this.blockPreferencesModal = null;\r\n            this.editing = editing;\r\n            this.sortField = null;\r\n            this.sortDirections = {};\r\n            this.isTotara = istotara;\r\n            this.pageLayout = pagelayout;\r\n            this.init();\r\n            /* require(['local_dash/isotope'], function (Isotope) {\r\n                //jQueryBridget('isotope', Isotope, $ );\r\n                $(document).ready(function() {\r\n                    $('.card_layout_masonry').isotope({\r\n                        // options...\r\n                        itemSelector: '.filtr-item',\r\n                        masonry: {\r\n                            columnWidth: 200\r\n                        }\r\n                    });\r\n                });\r\n            }); */\r\n            /* var grid = document.querySelector('.card_layout_masonry');\r\n            var iso = new Isotope( grid, {\r\n            // options...\r\n            itemSelector: '.filtr-item',\r\n            masonry: {\r\n                columnWidth: 200\r\n            }\r\n            }); */\r\n        };\r\n\r\n        DashInstance.prototype.BLOCK_CONTENT_SELECTOR = '.dash-block-content';\r\n        DashInstance.prototype.FILTER_FORM_SELECTOR = '.filter-form';\r\n\r\n        DashInstance.prototype.init = function() {\r\n            Log.debug('Initializing dash instance', this);\r\n\r\n            this.initDatePickers();\r\n            this.initSelect2();\r\n\r\n            if (this.editing) {\r\n                this.blockPreferencesModal = new PreferencesModal(this.getRoot().find('.dash-edit-preferences'),\r\n                    this.blockContextid, function() {\r\n                        // Preferences changed, go back to first page.\r\n                        this.currentPage = 0;\r\n                        this.refresh();\r\n                    }.bind(this));\r\n            }\r\n            this.getRoot().on('change', 'select:not(.norefresh), input:not(.select2-search__field)',\r\n                function(e) {\r\n                e.preventDefault();\r\n\r\n                Log.debug('Submitting filter form');\r\n                Log.debug(e);\r\n                Log.debug($(e.target).serializeArray());\r\n\r\n                // Filter results, go back to first page.\r\n                this.currentPage = 0;\r\n                this.refresh();\r\n            }.bind(this));\r\n\r\n            this.getBlockContentArea().on('click', '.page-link', function(e) {\r\n                e.preventDefault();\r\n                this.currentPage = $(e.target).data('page');\r\n                this.refresh();\r\n            }.bind(this));\r\n\r\n            this.getBlockContentArea().on('click', '.dash-sort', function(e) {\r\n                const $target = $(e.target);\r\n                this.sortField = $target.data('sort');\r\n\r\n                // Set sorting to asc by default.\r\n                if (!this.sortDirections.hasOwnProperty(this.sortField)) {\r\n                    this.sortDirections[this.sortField] = 'asc';\r\n                } else {\r\n                    // Toggle sort direction on field.\r\n                    this.sortDirections[this.sortField] = this.sortDirections[this.sortField] === 'asc' ? 'desc' : 'asc';\r\n                }\r\n                this.refresh();\r\n            }.bind(this));\r\n\r\n            if (this.isTotara) {\r\n                this.setDynamicTable();\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Get the root element of this dash instance.\r\n         *\r\n         * @method getRoot\r\n         * @return {object} jQuery object\r\n         */\r\n        DashInstance.prototype.getRoot = function() {\r\n            return this.root;\r\n        };\r\n\r\n        /**\r\n         * Get the content element of this dash instance.\r\n         *\r\n         * @method getRoot\r\n         * @return {object} jQuery object\r\n         */\r\n        DashInstance.prototype.getBlockContentArea = function() {\r\n            return this.getRoot().find(this.BLOCK_CONTENT_SELECTOR);\r\n        };\r\n\r\n        /**\r\n         * Get filter form element.\r\n         *\r\n         * @returns {object} jQuery object\r\n         */\r\n        DashInstance.prototype.getFilterForm = function() {\r\n            return this.getRoot().find(this.FILTER_FORM_SELECTOR);\r\n        };\r\n\r\n        DashInstance.prototype.getBlockContent = function() {\r\n            let sortDirection = null;\r\n            if (this.sortField && this.sortDirections.hasOwnProperty(this.sortField)) {\r\n                sortDirection = this.sortDirections[this.sortField];\r\n            }\r\n\r\n            var request = {\r\n                methodname: 'block_dash_get_block_content',\r\n                args: {\r\n                    \"block_instance_id\": this.blockInstanceId,\r\n                    \"filter_form_data\": JSON.stringify(this.getFilterForm().serializeArray()),\r\n                    \"page\": this.currentPage,\r\n                    \"sort_field\": this.sortField,\r\n                    \"sort_direction\": sortDirection,\r\n                    \"pagelayout\" : this.pageLayout,\r\n                }\r\n            };\r\n\r\n            return Ajax.call([request])[0];\r\n        };\r\n\r\n        DashInstance.prototype.refresh = function() {\r\n            this.getBlockContentArea().css('opacity', 0.5);\r\n            this.getBlockContent()\r\n                .then(function(response) {\r\n                    this.getBlockContentArea().html(response.html);\r\n                    this.getBlockContentArea().css('opacity', 1);\r\n                    this.initDatePickers();\r\n                    this.initSelect2();\r\n                    if (response.scripts) {\r\n                        Templates.runTemplateJS($(response.scripts).html() || response.scripts);\r\n                    }\r\n                }.bind(this))\r\n                .catch(Notification.exception);\r\n        };\r\n\r\n        DashInstance.prototype.initDatePickers = function() {\r\n            this.getRoot().find('.datepicker').datepicker2({\r\n                autoclose: true,\r\n                format: \"dd/mm/yyyy\"\r\n            });\r\n        };\r\n\r\n        DashInstance.prototype.initSelect2 = function() {\r\n            this.getRoot().find('.select2').each(function(index, element) {\r\n                let placeholder = null;\r\n                if ($(element).find(\"option[value='-1']\")) {\r\n                    placeholder = {\r\n                        id: '-1', // The value of the option.\r\n                        text: $(element).find(\"option[value='-1']\").text()\r\n                    };\r\n                }\r\n                $(element).select2({\r\n                    dropdownParent: this.getRoot(),\r\n                    allowClear: true,\r\n                    theme: 'bootstrap4',\r\n                    placeholder: placeholder\r\n                }).on('select2:unselecting', function() {\r\n                    $(this).data('unselecting', true);\r\n                }).on('select2:opening', function(e) {\r\n                    if ($(this).data('unselecting')) {\r\n                        $(this).removeData('unselecting');\r\n                        e.preventDefault();\r\n                    }\r\n                });\r\n            }.bind(this));\r\n        };\r\n\r\n        DashInstance.prototype.setDynamicTable = function() {\r\n\r\n            $('body').delegate('[data-table-dynamic=\"true\"] thead th a', 'click', function(e) {\r\n                e.preventDefault();\r\n                updateTable($(this));\r\n            });\r\n\r\n            $('body').delegate('.modal-body .paging a', 'click', function(e) {\r\n                e.preventDefault();\r\n                updateTable($(this));\r\n            });\r\n\r\n            var updateTable = function(element) {\r\n                var table = element.parents('.modal-body').find('table');\r\n\r\n                var href = element.attr('href');\r\n                var params = new URL(href).searchParams;\r\n                var page = params.get('page');\r\n                var sortfield = params.get('tsort');\r\n                if (sortfield == '') {\r\n                    sortfield = table.data('table-sort');\r\n                }\r\n\r\n                var tablehandler = table.data('table-handler');\r\n                var filter = table.data('table-filter');\r\n                var uniqueid = table.data('table-uniqueid');\r\n                var context = table.data('table-context');\r\n\r\n                var data = {\r\n                    handler: tablehandler,\r\n                    filter: filter,\r\n                    uniqueid: uniqueid,\r\n                    sort: sortfield,\r\n                    page: page\r\n                };\r\n\r\n                Fragment.loadFragment('block_dash', 'loadtable', context, data).then((html, js) => {\r\n                    $('.modal-body').html(html);\r\n                    Templates.runTemplateJS(js);\r\n                    return html;\r\n                }).catch(Notification.exception);\r\n            };\r\n        };\r\n\r\n        return DashInstance;\r\n    });\r\n"],"names":["define","$","UI","Log","Ajax","Notification","ModalEvents","PreferencesModal","DatePicker","Select2","Fragment","Templates","DashInstance","root","blockInstanceId","blockContextid","editing","istotara","pagelayout","this","currentPage","blockPreferencesModal","sortField","sortDirections","isTotara","pageLayout","init","prototype","BLOCK_CONTENT_SELECTOR","FILTER_FORM_SELECTOR","debug","initDatePickers","initSelect2","getRoot","find","refresh","bind","on","e","preventDefault","target","serializeArray","getBlockContentArea","data","$target","hasOwnProperty","setDynamicTable","getFilterForm","getBlockContent","sortDirection","request","methodname","args","block_instance_id","filter_form_data","JSON","stringify","page","sort_field","sort_direction","call","css","then","response","html","scripts","runTemplateJS","catch","exception","datepicker2","autoclose","format","each","index","element","placeholder","id","text","select2","dropdownParent","allowClear","theme","removeData","delegate","updateTable","table","parents","href","attr","params","URL","searchParams","get","sortfield","tablehandler","filter","uniqueid","context","handler","sort","loadFragment","js"],"mappings":"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"}